---
title: 微信公众支付问题集
date: 2018-02-02T02:10:00.000Z
lastmod: 2018-02-02T02:10:00.000Z
draft: true
keywords:
  - 微信
  - 公众号
  - 支付宝
  - 支付
description: 微信公众号、支付宝支付所遇到的问题
tags: []
categories: []
author: zbrid
comment: false
toc: false
autoCollapseToc: true
contentCopyright: false
reward: false
mathjax: false
---


公司最近应用开发到支付环节，在支付上遇到很多问题。今天统计留一个页面记录下所遇到的问题以及解决方式。本文纯从文字上讲起，不涉及任何代码。。。

<!--more-->


## 微信公众号支付

### 服务端

服务端采用PHP编写，使用了easywechat工具进行开发，服务端在编写好接口时，生成JSAPI端所需要使用的配置信息。返回信息如：
```json
{
    "success": true,
    "errors": [],
    "data": {
        "pre_id": "wx20180202092657b2323fe31aXXXXXXXXXX",
        "js_config": {
            "appId": "wx4bea8bXXXXXXXXXX",
            "nonceStr": "5a73be61b4ea1",
            "package": "prepay_id=wx20180202092657b2323fe31aXXXXXXXXX",
            "signType": "MD5",
            "paySign": "76FFE23CD1ECB867BE0BC342ABE8EAB3",
            "timestamp": "1517534817"
        }
    }
}
```
到这一步为止，服务端所要做的事情基本上差不多了。接下来，视角跳到微信公众号的配置与微信商户号上的配置上来。

### 微信公众号配置

微信公众号因为登陆太过于麻烦，所以就不粘贴图示了。主要讲几点。

* 1、微信公众号应该设置成开发者模式，这个应该不需要多说了吧，具体方式大家应该都是明了的了。
* 2、微信公众号设定网页授权地址，这个地址应该设定成服务端获取授权地址。

微信公众号的设置主要为上面两点，这里涉及到一个关于网页授权的问题。

**简单讲下**：当用户访问公众号页面的时候，微信服务器将携带code与URL信息跳转到我们所设定的回调地址上面，经服务端处理获取到当前用户信息之后再跳转到具体的公众号页面。
在这里，我们可以根据实际需求携带token给客户端（当然使用服务端渲染页面无此考虑），具体方式由各自应用自行处理。至此，我们已经获取到微信公众支付一个至关重要的东西openId了，这是公众号支付必需的一个阶段。

### 微信商户号配置

所以讲，人生的路岂会是平坦的呢，填坑的路也是漫漫无尽期的。别以为搞定openid生成微信支付的预支付ID就是万事大吉！NO ！NO ! NO ! 接下来的路还长着呢 ！！！

首先，获取预支付ID这儿要注意一下，虽然绝大多数支付接口并不太需O要商户号的证书，但如果涉及退款之类的操作的话，证书还是很重要的。

**当然最重要的还是支付KEY。**

这家伙可是所有接口必不可少的一个东西，但是呢，大家使用得注意它的有限期。
很多时候我们会发现之前调试好的接口为什么突然间生成不了预支付ID了，这个时候就应该来检查一下是否是这个KEY有效期到期了。

对了，还有，重新设定这个key的时候得注意千万不要设定成相同的KEY，很多人以为这样可以为当前的KEY延长生命周期，可实际采坑的人告诉你：**不可能！！！** 乖乖的换一个吧。

然后呢，有一个很多时候都不太注意的问题，那就是在商户号里面设定JS支付的地址目录。这里就有一个隐藏的属性，我们都以为只要设定到顶层目录上面，那在这个目录下面的子目录下的文件依然可以调起微信支付组件来。可实际情况嘛，我就呵呵呵了。目前情况呢，只有在设定目录下的文件才可以成功的调起支付。其实这个也不是很重要的哈，重要的是JS所报的错误，一般人根本看不懂啊，就只有一个**fail**,请问下，我该怎么根据错误去找问题啊？？


好了，到这里，微信支付应该没有多大的问题可以讲了，不过我还想吐槽下微信商户号。我用谷歌浏览器登陆一下你就那么困难吗？一遍又一遍你就是不让我输入密码。能不能把这个问题处理好点啊？？？还有更改一点配置，到处都是在收验证码，你家验证码不要钱啊？？？不嫌烦啊？？？


## 支付宝支付

说到支付宝，唉，先叹口气吧。支付宝你的支付文档能用点心么？找你一个接口不知道啊要死多少脑细胞！！在文档方面能不能学学微信？？当然，只学文档就可以了，其他的就不要学了。

所以说，人啊，还是贱，使用微信支付，嫌微信的各种麻烦；使用支付宝嫌支付宝文档又不好使。不过说真的，看支付宝文档真的要死好多脑细胞！！这个是真话！

### 支付宝配置

说实话，支付宝配置也是繁琐，不过它这个繁琐不是微信那种各种收验证码这种烦。而是，各种密钥的交叉让人觉得烦。各种密钥的配置让人感觉眼花缭乱的。

#### 新版与旧版支付区别。

1、目前阶段，支付宝移动支付存在老版与新版的区别，两个版本的区别的时间线是 **2016年8月10日**，在此之前的为老版支付。老版与新版的SDK不一致，所调用的接口也不一致，在进行签名的时候需要注意这个问题。
2、新版APP支付与旧版支付签名不一致，这一点尤其的重要，新版主要使用appid，而旧版主要使用商户号。
3、新版支付与旧版的API接口不一致，所需要的参数也是不一致的。

#### 支付密钥的设置问题

1、现目前支付宝密钥格式分为RSA与RSA2。它们主要区别是长度不一致rsa是1024的长度，rsa2是2048的长度，在新版实际情况下出现使用rsa密钥无效，需使用rsa2方才行的情况。所以，在实在找不出问题的时候尝试使用rsa2密钥吧。
2、应用公钥。这里的公钥是指当前应用我们自己所设定的公钥，这个公钥往往与我们代码里所配置的私钥是成对的。我们使用密钥加密，支付宝收到请求使用该公钥进行解密。
3、支付宝公钥。这个公钥指的的是，支付宝回调我们接口时，我们应该使用该公钥对请求参数解密。

#### 新版当中出现`AL40247`错误。

这个错误算是出的最多的了。这个问题的原因一般是因为`appid或者密钥不正确`的原因造成的。仔细检查便可发现该问题，**注意：这里有必要检查当前使用的rsa格式还是rsa2格式的密钥。**

#### 其他的问题

支付宝的移动支付需要签约之后方可使用个，所以在使用之前请务必确认当前是否有改功能的权限，如果没有的话，请先签约。虽然签约这个东西实在是不一般的繁琐。。。。

😌😌😌😌😌，到这里算是说完了微信和支付宝相关支付的问题了。使用别人的东西嘛，就得认清楚这个实情。乖乖低头好好检查下代码就好了。




